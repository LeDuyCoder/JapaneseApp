import 'dart:async';import 'package:flutter/cupertino.dart';import 'package:flutter/material.dart';import 'package:icons_plus/icons_plus.dart';import 'package:japaneseapp/Config/FunctionService.dart';import 'package:shared_preferences/shared_preferences.dart';class profileScreen extends StatefulWidget {  @override  State<StatefulWidget> createState() => _profileScreen();}class _profileScreen extends State<profileScreen> {  final List<String> weekdays = ["M", "T", "W", "T", "F", "S", "S"];  int amountTopicComplite = 0;  List<Map<String, String>> getWeekDays() {    DateTime today = DateTime.now();    int currentWeekday = today.weekday; // 1 = Th·ª© Hai, ..., 7 = Ch·ªß Nh·∫≠t    DateTime monday =        today.subtract(Duration(days: currentWeekday - 1)); // L√πi v·ªÅ Th·ª© Hai    List<Map<String, String>> days = [];    for (int i = 0; i < 7; i++) {      DateTime date = monday.add(Duration(days: i));      String formattedDate = "${date.day.toString().padLeft(2, '0')}";      String weekday = weekdays[i];      days.add({"date": formattedDate, "weekday": weekday});    }    return days;  }  List<Map<String, String>> getWeekDayMothYears() {    DateTime today = DateTime.now();    int currentWeekday = today.weekday; // 1 = Th·ª© Hai, ..., 7 = Ch·ªß Nh·∫≠t    DateTime monday =        today.subtract(Duration(days: currentWeekday - 1)); // L√πi v·ªÅ Th·ª© Hai    List<Map<String, String>> days = [];    for (int i = 0; i < 7; i++) {      DateTime date = monday.add(Duration(days: i));      String formattedDate =          "${date.day.toString().padLeft(2, '0')}/${date.month.toString().padLeft(2, '0')}/${date.year.toString()}";      String weekday = weekdays[i];      days.add({"date": formattedDate, "weekday": weekday});    }    print(days);    return days;  }  Future<Map<String, dynamic>> getData() async {    final SharedPreferences prefs = await SharedPreferences.getInstance();    amountTopicComplite = await FunctionService.getTopicComplite();    // await FunctionService.setAchivement("trithucdaysom");    //    // // List<String> Achivements = prefs.getStringList("achivement")!;    // // Achivements.remove("trithucchamchi");    // prefs.setStringList("achivement", Achivements);    // List<String> dates = ["22/02/2025", "23/02/2025", "24/02/2025", "25/02/2025"];    //prefs.setString("lastCheckIn", "24/02/2005");    // prefs.setStringList("checkInHistory", dates);    // prefs.setStringList("checkInHistoryTreak", dates);    // // FunctionService.setDay();    return {      "level": prefs.getInt("level"),      "exp": prefs.getInt("exp"),      "nextExp": prefs.getInt("nextExp"),      "Streak": prefs.getStringList("checkInHistoryTreak")!.length,      "lastCheckIn": prefs.getString("lastCheckIn"),      "checkInHistory": prefs.getStringList("checkInHistory"),      "checkInHistoryTreak": prefs.getStringList("checkInHistoryTreak"),      "achivement": prefs.getStringList("achivement")    };  }  String getTitle(int level) {    if (level < 10) {      return "H·ªçc Sƒ©";    } else if (level < 20) {      return "Minh Tri·∫øt Gi·∫£";    } else if (level < 30) {      return "T∆∞ T∆∞·ªüng Gia";    } else if (level < 40) {      return "B√°c H·ªçc T√¥n Gi·∫£";    } else if (level < 50) {      return "H√†n L√¢m H·ªçc Sƒ©";    } else if (level < 60) {      return "K·ª≥ T√†i VƒÉn H·ªçc";    } else if (level < 70) {      return "Tr√≠ Th√°nh Nh√¢n";    } else if (level < 80) {      return "Thi√™n T√†i Bi·ªán Lu·∫≠n";    } else if (level < 90) {      return "H·ªçc ƒê·∫°o Tinh Th√¥ng";    } else if (level < 100) {      return "Ch√≠ Sƒ© VƒÉn Nh√¢n";    } else if (level < 110) {      return "Luy·ªán T∆∞ H·ªçc Sƒ©";    } else if (level < 120) {      return "Th√¥ng Tu·ªá Gi·∫£";    } else if (level < 130) {      return "Hi·ªÅn Tri·∫øt Uy√™n Th√¢m";    } else if (level < 150) {      return "VƒÉn Nh√£ Ch√¢n Nh√¢n";    } else {      return "Tr√≠ Nh√¢n K·ª≥ T√†i";    }  }  String getImage(int level) {    if (level < 10) {      return "assets/StateLevel/state1.png";    } else if (level < 20) {      return "assets/StateLevel/state2.png";    } else if (level < 30) {      return "assets/StateLevel/state3.png";    } else if (level < 40) {      return "assets/StateLevel/state4.png";    } else if (level < 50) {      return "assets/StateLevel/state5.png";    } else if (level < 60) {      return "assets/StateLevel/state6.png";    } else if (level < 70) {      return "assets/StateLevel/state7.png";    } else if (level < 80) {      return "assets/StateLevel/state8.png";    } else if (level < 90) {      return "assets/StateLevel/state9.png";    } else if (level < 100) {      return "assets/StateLevel/state10.png";    } else if (level < 110) {      return "assets/StateLevel/state11.png";    } else if (level < 120) {      return "assets/StateLevel/state12.png";    } else if (level < 130) {      return "assets/StateLevel/state13.png";    } else if (level < 150) {      return "assets/StateLevel/state14.png";    } else {      return "assets/StateLevel/state15.png";    }  }  bool checkStreak(int userStreak, int streak){    return userStreak >= streak;  }  bool checkAchivement(Map<String, dynamic> data, String achivement){    return (data["achivement"] as List<String>).contains(achivement);  }  void showDialogAchivementInfor(BuildContext ctx, String title, String description, String image){    showDialog(      barrierDismissible: true,      context: context,      builder: (BuildContext context) {        return Dialog(          backgroundColor: Colors.white,          shape: const RoundedRectangleBorder(            borderRadius: BorderRadius.only(              bottomLeft: Radius.circular(10),              bottomRight: Radius.circular(10),            ), // Bo g√≥c popup          ),          child: StatefulBuilder(            builder: (BuildContext context, void Function(void Function()) setState) {              return Container(                width: MediaQuery.sizeOf(context).width*0.8,                decoration: const BoxDecoration(                  border: Border(                    top: BorderSide(                      color: Color.fromRGBO(20, 195, 142, 1.0), // M√†u xanh c·∫°nh tr√™n ngo√†i c√πng                      width: 10.0, // ƒê·ªô d√†y c·ªßa c·∫°nh tr√™n                    ),                  ),                ),                child: Stack(                  children: [                    Container(                      width: MediaQuery.sizeOf(context).width*0.8,                      child: Column(                        mainAxisSize: MainAxisSize.min,                        mainAxisAlignment: MainAxisAlignment.center,                        children: [                           Padding(                            padding: const EdgeInsets.only(left: 16, right: 16, top: 5),                            child: Text(                              title,                              style: TextStyle(fontSize: MediaQuery.sizeOf(context).width*0.06, fontFamily: "Itim", fontWeight: FontWeight.bold),                              textAlign: TextAlign.center,                            ),                          ),                            Image.asset(image, width: MediaQuery.sizeOf(context).width*0.4),                           Padding(                            padding: EdgeInsets.only(left: 16, right: 16, top: 5),                            child: Text(                              description,                              style: TextStyle(fontSize: MediaQuery.sizeOf(context).width*0.04, fontFamily: "Itim"),                              textAlign: TextAlign.center,                            ),                          ),                          const SizedBox(height: 20),                        ],                      ),                    )                  ],                ),              );            },          ),        );      },    );  }  @override  Widget build(BuildContext context) {    List<Map<String, String>> days = getWeekDays();    List<Map<String, String>> daymonthYears = getWeekDayMothYears();    DateTime today = DateTime.now();    String todayFormatted = "${today.day.toString().padLeft(2, '0')}";    List<int> topicMilestones = [1, 5, 10, 50, 100];    List<int> streakMilestones = [1, 5, 10, 20, 50];    List<Map<String, dynamic>> achievements = [      {        "title": "C√∫ ƒê√™m H·ªçc Khuya",        "description": "H·ªçc t·ª´ l√∫c 0h ƒë·∫øn 2 gi·ªù s√°ng",        "key": "cudemhockhuya",        "image": ["assets/achivement/overnight.png", "assets/achivement/no-overnight.png"],        "check": (data) => checkAchivement(data, "cudemhockhuya"),      },      {        "title": "Tri Th·ª©c ChƒÉm Ch·ªâ",        "description": "H·ªçc t·ª´ l√∫c 4 ƒë·∫øn 6 gi·ªù s√°ng",        "key": "trithucdaysom",        "image": ["assets/achivement/earnly.png", "assets/achivement/no-earnly.png"],        "check": (data) => checkAchivement(data, "trithucdaysom"),      },      {        "title": "H√¨nh Th√†nh Th√≥i Quen",        "description": "H·ªçc Li√™n Ti·∫øp 28 ng√†y",        "key": "Streak",        "image": ["assets/achivement/Habitualrot.png", "assets/achivement/no-Habitualrot.png"],        "check": (data) => checkStreak(data["Streak"], 28),      }    ];        return Scaffold(        body: FutureBuilder(            future: getData(),            builder: (ctx, snapshot) {              if (snapshot.hasData) {                return Container(                  height: MediaQuery.sizeOf(context).height,                  width: MediaQuery.sizeOf(context).width,                  color: Colors.white,                  child: SingleChildScrollView(                    scrollDirection: Axis.vertical,                    child: Column(                      children: [                        const SizedBox(                          height: 80,                        ),                        Stack(                          alignment: Alignment.center,                          children: [                            // Container VI·ªÄN (background)                            Container(                              width: MediaQuery.sizeOf(context).width * 0.6,                              height: MediaQuery.sizeOf(context).width * 0.8,                              decoration: BoxDecoration(                                borderRadius:                                    const BorderRadius.all(Radius.circular(20)),                                border: Border.all(                                    width: 10, color: Colors.transparent),                                image: const DecorationImage(                                  image: AssetImage(                                      'assets/textureBoder/textureStone.png'),                                  repeat: ImageRepeat.repeat, // L·∫∑p texture                                ),                                boxShadow: const [                                  BoxShadow(                                    color: Colors.grey,                                    blurRadius: 20,                                    offset: Offset(4, 4),                                  ),                                ],                              ),                            ),                            // Container N·ªòI DUNG (che ph·ªß)                            Container(                                width: MediaQuery.sizeOf(context).width * 0.57,                                height: MediaQuery.sizeOf(context).width * 0.77,                                decoration: const BoxDecoration(                                  color: Colors.white, // M√†u n·ªÅn b√™n trong                                  borderRadius:                                      BorderRadius.all(Radius.circular(20)),                                ),                                child: Center(                                  child: Image.asset(                                    getImage(snapshot.data!["level"]),                                    width:                                        MediaQuery.sizeOf(context).width * 0.45,                                  ),                                )),                          ],                        ),                        SizedBox(                          height: 20,                        ),                        Text(                          "B·∫≠c Tri Th·ª©c: ${snapshot.data!["level"]}",                          style: TextStyle(fontFamily: "Itim", fontSize: 35),                        ),                        Container(                          width: MediaQuery.sizeOf(context).width,                          child: Text(                            "Ki·∫øn Th·ª©c: ${snapshot.data!["exp"]}/${snapshot.data!["nextExp"]}",                            style: TextStyle(fontFamily: "Itim", fontSize: 25),                            maxLines: 2,                            textAlign: TextAlign.center,                          ),                        ),                        Container(                          width: MediaQuery.sizeOf(context).width,                          child: Text(                            "Danh Hi·ªáu: ${getTitle(snapshot.data!["level"])}",                            style: TextStyle(fontFamily: "Itim", fontSize: 25),                            maxLines: 2,                            textAlign: TextAlign.center,                          ),                        ),                        SizedBox(                          height: 20,                        ),                        Divider(                          color: Colors.grey.shade300, // M√†u c·ªßa ƒë∆∞·ªùng k·∫ª                          thickness: 5,                          // indent: MediaQuery.sizeOf(context).width,                          // endIndent: MediaQuery.sizeOf(context).width,// ƒê·ªô d√†y                        ),                        const SizedBox(                          height: 20,                        ),                        Row(                          mainAxisAlignment: MainAxisAlignment.center,                          children: [                            Text("${snapshot.data!["Streak"]}",                                style: TextStyle(                                    color: ((snapshot.data!["checkInHistory"]                                                as List<String>)                                            .contains(                                                "${today.day.toString().padLeft(2, '0')}/${today.month.toString().padLeft(2, '0')}/${today.year.toString()}"))                                        ? Colors.orange                                        : Colors.grey,                                    fontWeight: FontWeight.bold,                                    fontSize: 30)),                            Icon(                              Icons.local_fire_department,                              color: ((snapshot.data!["checkInHistory"]                                          as List<String>)                                      .contains(                                          "${today.day.toString().padLeft(2, '0')}/${today.month.toString().padLeft(2, '0')}/${today.year.toString()}"))                                  ? Colors.orange                                  : Colors.grey,                              size: 50,                            )                          ],                        ),                        Text(                          "Th√°ng ${today.month.toString().padLeft(2, '0')} NƒÉm ${today.year.toString()}",                          style: const TextStyle(                              color: Colors.green,                              fontWeight: FontWeight.bold,                              fontSize: 20,                              fontFamily: "Itim"                          ),                        ),                        Padding(                          padding: EdgeInsets.all(16),                          child: Column(                            children: [                              // Hi·ªÉn th·ªã t√™n th·ª© (T2 -> CN)                              Row(                                mainAxisAlignment:                                    MainAxisAlignment.spaceBetween,                                children: weekdays.map((day) {                                  return Expanded(                                    child: Center(                                      child: Text(                                        day,                                        style: const TextStyle(                                            fontSize: 20,                                            fontWeight: FontWeight.bold,                                            color: Colors.blue),                                      ),                                    ),                                  );                                }).toList(),                              ),                              // Hi·ªÉn th·ªã ng√†y theo h√†ng ngang                              GridView.builder(                                shrinkWrap: true,                                gridDelegate:                                    const SliverGridDelegateWithFixedCrossAxisCount(                                  crossAxisCount: 7, // 7 √¥ theo h√†ng ngang                                  childAspectRatio: 1.2, // CƒÉn ch·ªânh t·ªâ l·ªá √¥                                ),                                itemCount: days.length,                                itemBuilder: (context, index) {                                  bool isToday =                                      days[index]["date"] == todayFormatted;                                  return Stack(                                    children: [                                      Container(                                        margin: EdgeInsets.all(4),                                        decoration: BoxDecoration(                                          border: Border.all(                                              color: isToday                                                  ? Colors.black                                                  : Colors.black                                                      .withOpacity(0.0)),                                          borderRadius: BorderRadius.all(Radius.circular(10))                                        ),                                        child: Center(                                          child: Text(                                            days[index]["date"]!,                                            style: const TextStyle(                                              color: Colors.black,                                              fontSize: 18,                                              fontWeight: FontWeight.bold,                                            ),                                          ),                                        ),                                      ),                                      if ((snapshot.data!["checkInHistory"]                                      as List<String>)                                          .contains(                                          daymonthYears[index]["date"]))                                        Text("üî•"),                                    ],                                  );                                },                              ),                            ],                          ),                        ),                        Divider(                          color: Colors.grey.shade300, // M√†u c·ªßa ƒë∆∞·ªùng k·∫ª                          thickness: 5,                          // indent: MediaQuery.sizeOf(context).width,                          // endIndent: MediaQuery.sizeOf(context).width,// ƒê·ªô d√†y                        ),                        const Text(                          "H·ªçc T·∫≠p",                          style: TextStyle(                              color: Colors.green,                              fontWeight: FontWeight.bold,                              fontSize: 30,                              fontFamily: "Itim"                          ),                        ),                        SizedBox(height: 10,),                        Padding(                          padding: const EdgeInsets.only(left: 10, right: 5),                          child: SingleChildScrollView(                            scrollDirection: Axis.horizontal,                            child: Row(                              mainAxisAlignment: MainAxisAlignment.spaceBetween,                              children: achievements.map((achievement) {                                String imagePath = achievement["check"](snapshot.data!)                                    ? achievement["image"][0]                                    : achievement["image"][1];                                return GestureDetector(                                  onTap: () {                                    if (achievement.containsKey("description")) {                                      showDialogAchivementInfor(ctx, achievement["title"], achievement["description"], imagePath);                                    }                                  },                                  child: Padding(                                    padding: EdgeInsets.only(right: 10),                                    child: Column(                                      children: [                                        Image.asset(imagePath, scale: 3),                                        Text(                                          achievement["title"],                                          style: const TextStyle(                                            color: Colors.black,                                            fontSize: 20,                                            fontFamily: "Itim",                                          ),                                        ),                                      ],                                    ),                                  )                                );                              }).toList(),                            ),                          ),                        ),                        Divider(                          color: Colors.grey.shade300, // M√†u c·ªßa ƒë∆∞·ªùng k·∫ª                          thickness: 5,                          // indent: MediaQuery.sizeOf(context).width,                          // endIndent: MediaQuery.sizeOf(context).width,// ƒê·ªô d√†y                        ),                        const Text(                          "Chu·ªïi Ng√†y H·ªçc",                          style: TextStyle(                              color: Colors.green,                              fontWeight: FontWeight.bold,                              fontSize: 30,                              fontFamily: "Itim"                          ),                        ),                        SizedBox(height: 10,),                        Padding(                          padding: const EdgeInsets.only(left: 15, right: 5),                          child: SingleChildScrollView(                            scrollDirection: Axis.horizontal,                            child: Row(                              children: streakMilestones.map((streak) {                                String imagePath = checkStreak(snapshot.data!["Streak"], streak)                                    ? "assets/achivement/dayStreak/${streak}day.png"                                    : "assets/achivement/dayStreak/no-${streak}day.png";                                return GestureDetector(                                  onTap: (){                                    showDialogAchivementInfor(ctx, "Chu·ªói $streak ng√†y", "Nh·∫≠n khi h·ªçc li√™n t·ª•c $streak ng√†y", imagePath);                                  },                                  child: Padding(                                    padding: EdgeInsets.only(right: 20),                                    child: Column(                                      children: [                                        Image.asset(imagePath, scale: 14),                                        SizedBox(height: MediaQuery.sizeOf(context).width * 0.03),                                        Text(                                          "Chu·ªói $streak ng√†y",                                          style: const TextStyle(                                            color: Colors.black,                                            fontSize: 20,                                            fontFamily: "Itim",                                          ),                                        ),                                      ],                                    ),                                  ),                                );                              }).toList(),                            ),                          ),                        ),                        Divider(                          color: Colors.grey.shade300, // M√†u c·ªßa ƒë∆∞·ªùng k·∫ª                          thickness: 5,                          // indent: MediaQuery.sizeOf(context).width,                          // endIndent: MediaQuery.sizeOf(context).width,// ƒê·ªô d√†y                        ),                        Column(                          mainAxisAlignment: MainAxisAlignment.center,                          children: [                            Row(                              mainAxisAlignment: MainAxisAlignment.center,                              children: [                                Text(                                  "$amountTopicComplite",                                  style: const TextStyle(                                      color: Colors.blue,                                      fontWeight: FontWeight.bold,                                      fontSize: 40,                                      fontFamily: "Itim"                                  ),                                ),                                const Icon(Icons.water_drop_rounded, size: 50, color: Colors.blue,)                              ],                            ),                            const Text(                              "Topic Ho√†n Th√†nh",                              style: TextStyle(                                  color: Colors.green,                                  fontWeight: FontWeight.bold,                                  fontSize: 30,                                  fontFamily: "Itim"                              ),                            ),                          ],                        ),                        SizedBox(height: 10,),                        Padding(                          padding: const EdgeInsets.only(left: 15, right: 5),                          child: SingleChildScrollView(                            scrollDirection: Axis.horizontal,                            child: Row(                              children: topicMilestones.map((topic) {                                String imagePath = amountTopicComplite >= topic                                    ? "assets/achivement/finish/${topic}_finish.png"                                    : "assets/achivement/finish/no_${topic}_finish.png";                                return GestureDetector(                                  onTap: () {                                    showDialogAchivementInfor(                                      ctx,                                      "$topic Topic",                                      "Nh·∫≠n sau khi ho√†n th√†nh $topic topic",                                      imagePath,                                    );                                  },                                  child: Padding(                                    padding: const EdgeInsets.only(right: 20),                                    child: Column(                                      children: [                                        Image.asset(imagePath, scale: 11),                                        Text(                                          "$topic Topic",                                          style: const TextStyle(                                            color: Colors.black,                                            fontSize: 20,                                            fontFamily: "Itim",                                          ),                                        ),                                      ],                                    ),                                  ),                                );                              }).toList(),                            ),                          ),                        ),                        SizedBox(height: 50,),                      ],                    ),                  ),                );              }              print(snapshot.data);              return const Center();            }));  }}